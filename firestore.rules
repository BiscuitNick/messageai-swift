rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isDocumentOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isConversationParticipant(conversationData) {
      return request.auth != null
          && conversationData.participantIds.hasAny([request.auth.uid]);
    }

    match /users/{userId} {
      allow read: if isAuthenticated()
        && (isDocumentOwner(userId) || resource.data.visibility == 'public' || true);

      allow create: if isDocumentOwner(userId);

      allow update: if isDocumentOwner(userId);

      allow delete: if false;
    }

    match /bots/{botId} {
      allow read: if isAuthenticated();

      allow create, update: if isAuthenticated();

      allow delete: if false;
    }

    match /conversations/{conversationId} {
      allow read: if isAuthenticated()
        && isConversationParticipant(resource.data);

      allow create: if isAuthenticated()
        && isConversationParticipant(request.resource.data)
        && request.resource.data.participantIds.size() >= 2;

      allow update: if isAuthenticated()
        && isConversationParticipant(resource.data)
        && isConversationParticipant(request.resource.data);

      allow delete: if false;

      match /messages/{messageId} {
        // Allow participants to read messages
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow participants to create messages
        allow create: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid])
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.conversationId == conversationId;

        // Allow sender to update their own message (for delivery state updates)
        // Also allow any participant to update delivery state (for read receipts)
        allow update: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid])
          && (
            request.resource.data.senderId == resource.data.senderId  // No changing sender
            && request.resource.data.text == resource.data.text       // No changing text
            && request.resource.data.conversationId == resource.data.conversationId  // No changing conversation
          );

        allow delete: if false;
      }

      match /actionItems/{actionItemId} {
        // Allow participants to read action items
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow participants to create/update action items
        // Cloud Functions also write via Admin SDK (bypasses these rules)
        allow write: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow participants to delete action items
        allow delete: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      }

      match /decisions/{decisionId} {
        // Allow participants to read decisions
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow participants to create/update decisions
        // Cloud Functions also write via Admin SDK (bypasses these rules)
        allow write: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow participants to delete decisions
        allow delete: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      }

      match /typing/{userId} {
        // Allow participants to read typing indicators
        allow read: if isAuthenticated()
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow users to write/update their own typing status only
        allow write: if isAuthenticated()
          && request.auth.uid == userId
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);

        // Allow users to delete their own typing status
        allow delete: if isAuthenticated()
          && request.auth.uid == userId;
      }
    }

    // AI Telemetry - authenticated users can write their own telemetry events
    match /ai_telemetry/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // AI Feedback - authenticated users can write their own feedback
    match /ai_feedback/{feedbackId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated()
                   && request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // Coordination Insights - written by Cloud Functions, read by authenticated users
    match /coordinationInsights/{insightId} {
      // Allow authenticated users to read insights
      // Cloud Functions use Admin SDK which bypasses these rules for writes
      allow read: if isAuthenticated();
      allow write: if false; // Client writes blocked - only Cloud Functions can write via Admin SDK
      allow delete: if false;
    }
  }
}
